<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>DMX OTA V1 Configuration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <style>
        .device-list {
            max-height: 70vh;
            overflow-y: auto;
        }
        .device-item {
            cursor: pointer;
        }
        .device-item.active {
            background-color: #0d6efd;
            color: white;
        }
        @media (min-width: 1400px) {
            .col-xxl-4 {
                flex: 0 0 auto;
                width: 33.333333%;
            }
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/dashboard}">ArtNet Control</a>
        <div>
            <a class="btn btn-outline-light me-2" th:href="@{/web/devices}">Devices</a>
            <a class="btn btn-outline-light" th:href="@{/web/dmx-ota}">DMX OTA V1</a>
            <a class="btn btn-outline-light" th:href="@{/login}">Login</a>
        </div>
    </div>
</nav>

<div class="container-fluid">

    <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
    <div class="row justify-content-center">
        <div class="col-12 col-md-6 col-xxl-4 order-2 order-md-1 mb-3">

            <div class="card">
                <div class="card-header">
                    <strong>Devices</strong>
                </div>
                <div class="card-body">
                    <input type="text"
                           id="deviceSearch"
                           class="form-control mb-3"
                           placeholder="Search by device name...">

                    <ul class="list-group device-list" id="deviceList">
                        <li th:each="device : ${devices}"
                            class="list-group-item device-item"
                            th:data-device-id="${device.uuid}"
                            th:data-device-name="${device.name}"
                            th:data-url="${device.artnetUrl}"
                            th:text="${device.name} + ' (' + ${device.artnetUrl} + ')'">
                            Device Name (artnetUrl)
                        </li>

                        <li th:if="${devices == null or #lists.isEmpty(devices)}"
                            class="list-group-item text-muted">
                            No DMX OTA V1 compatible devices found.
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- RIGHT: config form -->
        <div class="col-12 col-md-6 col-xxl-4 order-1 order-md-2 mb-3">
            <div class="card">
                <div class="card-header">
                    <strong>DMX Configuration</strong>
                </div>
                <div class="card-body">
                    <form th:action="@{/web/dmx-ota/send}"
                          th:object="${dmxConfig}"
                          method="post"
                          id="dmxConfigForm">

                        <input type="hidden" th:field="*{deviceUUID}" id="selectedDeviceId"/>
                        <input type="hidden" th:field="*{url}" id="url"/>

                        <div class="mb-3">
                            <label class="form-label">Selected Device</label>
                            <input type="text" class="form-control" id="selectedDeviceName" readonly
                                   placeholder="No device selected">
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">DMX Address</label>
                                <input type="number"
                                       class="form-control"
                                       th:field="*{dmxAddress}"
                                       min="0" max="511"
                                       placeholder="0-511">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">DMX Mode</label>
                                <select class="form-select" th:field="*{dmxMode}">
                                    <option value="" disabled selected>Select DMX Mode</option>
                                    <option th:each="mode, iter : ${dmxModes}"
                                            th:value="${iter.index}"
                                            th:text="${mode}">
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">DMX Universe</label>
                                <input type="number"
                                       class="form-control"
                                       th:field="*{dmxUniverse}"
                                       min="0" max="15"
                                       placeholder="0-15"

                                >
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Receiver Type</label>
                                <select class="form-select" th:field="*{receiverType}">
                                    <option value="" disabled selected>Select Receiver Type</option>
                                    <option th:each="rt, iter : ${receiverTypes}"
                                            th:value="${iter.index}"
                                            th:text="${rt}">
                                    </option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" id="send-button" disabled>
                            Send DMX Configuration
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
</script>

<script>
    const searchInput = document.getElementById('deviceSearch');
    const deviceList = document.getElementById('deviceList');
    const deviceItems = deviceList ? deviceList.getElementsByClassName('device-item') : [];

    const selectedDeviceNameInput = document.getElementById('selectedDeviceName');
    const deviceUUIDInput = document.getElementById('selectedDeviceId');
    const deviceUrlInput  = document.getElementById('url');

    // Search filter
    searchInput.addEventListener('keyup', function () {
        const filter = this.value.toLowerCase();
        for (let i = 0; i < deviceItems.length; i++) {
            const name = deviceItems[i].getAttribute('data-device-name') || '';
            const text = deviceItems[i].textContent || deviceItems[i].innerText || '';
            const haystack = (name + ' ' + text).toLowerCase();
            deviceItems[i].style.display = haystack.includes(filter) ? '' : 'none';
        }
    });

    // Single selection logic
    for (let i = 0; i < deviceItems.length; i++) {
        deviceItems[i].addEventListener('click', function () {

            // Remove highlight
            for (let j = 0; j < deviceItems.length; j++) {
                deviceItems[j].classList.remove('active');
            }
            this.classList.add('active');

            const sendButton = document.getElementById('send-button');
            sendButton.disabled = false;

            // Extract attributes
            const deviceUUID = this.getAttribute('data-device-id');
            const deviceURL  = this.getAttribute('data-url');
            const deviceName = this.getAttribute('data-device-name');

            // Fill UI fields
            selectedDeviceNameInput.value = deviceName;

            // Fill hidden form fields (the important part)
            deviceUUIDInput.value = deviceUUID;
            deviceUrlInput.value  = deviceURL;
        });
    }
</script>
</body>
</html>
